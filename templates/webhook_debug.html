<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webhook Debug Console - Bobby's Table</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 20px;
            background-color: #1a1a1a;
            color: #00ff00;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: #2a2a2a;
            border-radius: 8px;
            border: 2px solid #00ff00;
        }
        
        .header h1 {
            margin: 0;
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00;
        }
        
        .controls {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .btn {
            background-color: #333;
            border: 2px solid #00ff00;
            color: #00ff00;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 4px;
            font-family: inherit;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background-color: #00ff00;
            color: #1a1a1a;
            box-shadow: 0 0 10px #00ff00;
        }
        
        .status {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #2a2a2a;
            border-radius: 8px;
            border-left: 4px solid #00ff00;
        }
        
        .webhook-log {
            background-color: #0a0a0a;
            border: 2px solid #00ff00;
            border-radius: 8px;
            padding: 20px;
            height: 600px;
            overflow-y: auto;
            font-size: 14px;
        }
        
        .webhook-entry {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #1a1a1a;
            border-left: 4px solid #00ff00;
            border-radius: 4px;
        }
        
        .webhook-entry.error {
            border-left-color: #ff0000;
            color: #ff9999;
        }
        
        .webhook-entry.success {
            border-left-color: #00ff00;
            color: #99ff99;
        }
        
        .webhook-entry.info {
            border-left-color: #0099ff;
            color: #99ccff;
        }
        
        .timestamp {
            color: #888;
            font-size: 12px;
            margin-bottom: 5px;
        }
        
        .method {
            display: inline-block;
            padding: 2px 8px;
            background-color: #333;
            border-radius: 3px;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .method.POST { background-color: #28a745; }
        .method.GET { background-color: #007bff; }
        .method.PUT { background-color: #ffc107; color: #000; }
        .method.DELETE { background-color: #dc3545; }
        
        .json-data {
            background-color: #000;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            overflow-x: auto;
            white-space: pre-wrap;
            font-size: 12px;
        }
        
        .endpoint-info {
            background-color: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .endpoint-url {
            color: #00ff00;
            font-weight: bold;
            word-break: break-all;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background-color: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #00ff00;
            flex: 1;
            margin: 0 5px;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #00ff00;
        }
        
        .stat-label {
            font-size: 12px;
            color: #888;
        }
        
        .btn.danger {
            background-color: #dc3545;
            border-color: #dc3545;
            color: white;
            cursor: pointer;
        }
        
        .btn.danger:hover:not(:disabled) {
            background-color: #c82333;
            border-color: #bd2130;
            cursor: pointer;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn:disabled:hover {
            background-color: #333;
            color: #00ff00;
            box-shadow: none;
        }
        
        .btn.danger:disabled {
            background-color: #6c757d;
            border-color: #6c757d;
            opacity: 0.6;
        }
        
        .btn.danger:disabled:hover {
            background-color: #6c757d;
            border-color: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔧 WEBHOOK DEBUG CONSOLE</h1>
            <p>Bobby's Table Restaurant System - Real-time Webhook Monitor</p>
        </div>
        
        <div class="endpoint-info">
            <strong>Debug Endpoint:</strong> 
            <span class="endpoint-url" id="endpoint-url">Loading...</span>
        </div>
        
        <div class="stats">
            <div class="stat-box">
                <div class="stat-number" id="total-requests">0</div>
                <div class="stat-label">Total Requests</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="success-requests">0</div>
                <div class="stat-label">Success</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="error-requests">0</div>
                <div class="stat-label">Errors</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="last-request">Never</div>
                <div class="stat-label">Last Request</div>
            </div>
        </div>
        
        <div class="status" id="status">
            <strong>Status:</strong> <span id="status-text">Initializing webhook monitor...</span>
        </div>
        
        <div class="controls">
            <button class="btn" onclick="clearLog()">Clear Log</button>
            <button class="btn" onclick="exportLog()">Export Log</button>
            <button class="btn" onclick="toggleAutoScroll()">
                <span id="autoscroll-text">Auto Scroll: ON</span>
            </button>
            <button class="btn" id="send-test-btn" onclick="sendTestWebhook()">Send Test</button>
            <button class="btn danger" id="stop-test-btn" onclick="stopTest()" disabled>🛑 Stop Test</button>
        </div>
        
        <div class="webhook-log" id="webhook-log">
            <div class="webhook-entry info">
                <div class="timestamp">System initialized</div>
                <div>🚀 Webhook debug console ready. Waiting for incoming webhooks...</div>
            </div>
        </div>
    </div>

    <script>
        let webhookData = [];
        let totalRequests = 0;
        let successRequests = 0;
        let errorRequests = 0;
        let autoScroll = true;
        let testInProgress = false;
        let testAbortController = null;
        let pollInterval = null;
        let lastPollTimestamp = null;
        
        // Get current URL and construct webhook endpoint
        const currentUrl = window.location.origin;
        const webhookEndpoint = `${currentUrl}/webhook-debug`;
        document.getElementById('endpoint-url').textContent = webhookEndpoint;
        
        function updateStats() {
            document.getElementById('total-requests').textContent = totalRequests;
            document.getElementById('success-requests').textContent = successRequests;
            document.getElementById('error-requests').textContent = errorRequests;
            
            if (totalRequests > 0) {
                const lastTime = new Date().toLocaleTimeString();
                document.getElementById('last-request').textContent = lastTime;
            }
        }
        
        function addLogEntry(type, method, url, data, headers = {}) {
            const timestamp = new Date().toISOString();
            const timeString = new Date().toLocaleTimeString();
            
            const entry = {
                timestamp,
                type,
                method,
                url,
                data,
                headers
            };
            
            webhookData.push(entry);
            totalRequests++;
            
            if (type === 'success') successRequests++;
            if (type === 'error') errorRequests++;
            
            const logContainer = document.getElementById('webhook-log');
            const entryDiv = document.createElement('div');
            entryDiv.className = `webhook-entry ${type}`;
            
            entryDiv.innerHTML = `
                <div class="timestamp">${timeString} (${timestamp})</div>
                <div>
                    <span class="method ${method}">${method}</span>
                    <strong>${url || 'Unknown endpoint'}</strong>
                </div>
                ${Object.keys(headers).length > 0 ? `
                <div style="margin-top: 10px;">
                    <strong>Headers:</strong>
                    <div class="json-data">${JSON.stringify(headers, null, 2)}</div>
                </div>
                ` : ''}
                ${data ? `
                <div style="margin-top: 10px;">
                    <strong>Payload:</strong>
                    <div class="json-data">${typeof data === 'string' ? data : JSON.stringify(data, null, 2)}</div>
                </div>
                ` : ''}
            `;
            
            logContainer.appendChild(entryDiv);
            
            if (autoScroll) {
                logContainer.scrollTop = logContainer.scrollHeight;
            }
            
            updateStats();
            updateStatus();
        }
        
        function updateStatus() {
            const statusText = document.getElementById('status-text');
            if (totalRequests === 0) {
                statusText.textContent = 'Waiting for first webhook...';
            } else {
                statusText.textContent = `Active - ${totalRequests} requests received`;
            }
        }
        
        function clearLog() {
            document.getElementById('webhook-log').innerHTML = `
                <div class="webhook-entry info">
                    <div class="timestamp">Log cleared</div>
                    <div>🧹 Webhook log cleared. Ready for new requests...</div>
                </div>
            `;
            webhookData = [];
            totalRequests = 0;
            successRequests = 0;
            errorRequests = 0;
            updateStats();
            updateStatus();
        }
        
        function exportLog() {
            const dataStr = JSON.stringify(webhookData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `webhook-debug-${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }
        
        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            document.getElementById('autoscroll-text').textContent = `Auto Scroll: ${autoScroll ? 'ON' : 'OFF'}`;
        }
        
        function updateTestButtons() {
            const sendTestBtn = document.getElementById('send-test-btn');
            const stopTestBtn = document.getElementById('stop-test-btn');
            
            if (testInProgress) {
                sendTestBtn.disabled = true;
                stopTestBtn.disabled = false;
            } else {
                sendTestBtn.disabled = false;
                stopTestBtn.disabled = true;
            }
        }
        
        function stopTest() {
            if (testAbortController) {
                testAbortController.abort();
            }
            testInProgress = false;
            testAbortController = null;
            updateTestButtons();
            addLogEntry('info', 'INFO', 'System', '🛑 Test stopped by user - continuing to monitor for webhooks');
        }
        
        function sendTestWebhook() {
            if (testInProgress) return;
            
            testInProgress = true;
            testAbortController = new AbortController();
            updateTestButtons();
            
            const testData = {
                test: true,
                timestamp: new Date().toISOString(),
                type: 'test_webhook',
                data: {
                    reservation_id: '123456',
                    status: 'completed',
                    amount: 45.67
                }
            };
            
            addLogEntry('info', 'INFO', 'System', '🚀 Starting test webhook...');
            
            fetch('/webhook-debug', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(testData),
                signal: testAbortController.signal
            }).then(response => {
                if (!testAbortController.signal.aborted) {
                    addLogEntry('success', 'POST', '/webhook-debug', testData, {
                        'Content-Type': 'application/json',
                        'User-Agent': 'Debug Console Test'
                    });
                }
            }).catch(error => {
                if (error.name === 'AbortError') {
                    addLogEntry('info', 'INFO', 'System', '🛑 Test webhook cancelled');
                } else {
                    addLogEntry('error', 'POST', '/webhook-debug', `Test failed: ${error.message}`);
                }
            }).finally(() => {
                // Test completed, but keep polling for other webhooks
                testInProgress = false;
                testAbortController = null;
                updateTestButtons();
                addLogEntry('info', 'INFO', 'System', '⏹️ Test completed - continuing to monitor for webhooks');
            });
        }
        
        // Poll for new webhook data (if implemented on server side)
        function pollWebhooks() {
            fetch('/webhook-debug/poll')
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Polling not available');
                })
                .then(data => {
                    if (data.webhooks && data.webhooks.length > 0) {
                        // Only show new webhooks since last poll
                        const newWebhooks = lastPollTimestamp 
                            ? data.webhooks.filter(webhook => new Date(webhook.timestamp) > new Date(lastPollTimestamp))
                            : data.webhooks;
                        
                        newWebhooks.forEach(webhook => {
                            addLogEntry(
                                webhook.success ? 'success' : 'error',
                                webhook.method || 'POST',
                                webhook.url || '/webhook-debug',
                                webhook.data,
                                webhook.headers || {}
                            );
                        });
                        
                        // Update last poll timestamp to the latest webhook timestamp
                        if (data.webhooks.length > 0) {
                            lastPollTimestamp = data.webhooks[data.webhooks.length - 1].timestamp;
                        }
                    }
                })
                .catch(error => {
                    // Silently fail - polling is optional
                });
        }
        
        // Start continuous polling to capture all incoming webhooks
        function startPolling() {
            if (!pollInterval) {
                pollInterval = setInterval(pollWebhooks, 2000);
                addLogEntry('info', 'INFO', 'System', '🔄 Started monitoring for incoming webhooks...');
            }
        }
        
        // Add keyboard shortcut to stop test (ESC key)
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && testInProgress) {
                stopTest();
            }
        });
        
        // Initialize
        updateStatus();
        updateTestButtons();
        
        // Start polling immediately to capture all webhook data
        startPolling();
        
        // Add some helpful information
        setTimeout(() => {
            addLogEntry('info', 'INFO', 'System', 
                'To test webhooks, send POST requests to: ' + webhookEndpoint + 
                '\n\nExample curl command:\ncurl -X POST ' + webhookEndpoint + 
                ' \\\n  -H "Content-Type: application/json" \\\n  -d \'{"test": "data", "timestamp": "' + 
                new Date().toISOString() + '"}\''
            );
        }, 1000);
    </script>
</body>
</html> 